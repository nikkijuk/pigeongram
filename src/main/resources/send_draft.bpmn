<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_1xucihv" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="4.11.1" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.15.0">
  <bpmn:process id="SendDraftProcess" name="Send draft" isExecutable="true" camunda:candidateStarterUsers="demo">
    <bpmn:startEvent id="start_event_dend_draft" name="draft send requested">
      <bpmn:extensionElements>
        <camunda:properties>
          <camunda:property name="draftId" />
          <camunda:property name="archive" />
        </camunda:properties>
      </bpmn:extensionElements>
      <bpmn:outgoing>Flow_0ee2l7i</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="Flow_0ee2l7i" sourceRef="start_event_dend_draft" targetRef="ValidateDraftActivity" />
    <bpmn:sequenceFlow id="Flow_Message_Draft_Checked" sourceRef="ValidateDraftActivity" targetRef="MoveToOutboxActivity" />
    <bpmn:sequenceFlow id="Flow_Message_moved_to_outbox" sourceRef="MoveToOutboxActivity" targetRef="SendMessageActivity" />
    <bpmn:sequenceFlow id="Flow_Message_sent" sourceRef="SendMessageActivity" targetRef="MoveToSentActivity" />
    <bpmn:exclusiveGateway id="ArchiveMessageGateway" name="archiving needed?" default="flow_archive_needed">
      <bpmn:incoming>Flow_Message_Moved_to_sent</bpmn:incoming>
      <bpmn:outgoing>flow_archive_needed</bpmn:outgoing>
      <bpmn:outgoing>flow_archive_not_needed</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:sequenceFlow id="Flow_Message_Moved_to_sent" sourceRef="MoveToSentActivity" targetRef="ArchiveMessageGateway" />
    <bpmn:sequenceFlow id="flow_archive_needed" name="yes" sourceRef="ArchiveMessageGateway" targetRef="ArchiveMessageActivity" />
    <bpmn:sequenceFlow id="Flow_0thveet" name="draft incomplete" sourceRef="ValidateDraftError" targetRef="DraftValidationNotifyUser" />
    <bpmn:endEvent id="end_event_draft_validation_failed" name="incomplete draft">
      <bpmn:incoming>Flow_1wrsceu</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_1wrsceu" sourceRef="DraftValidationNotifyUser" targetRef="end_event_draft_validation_failed" />
    <bpmn:endEvent id="end_event_draft_sending_failed" name="sending failed">
      <bpmn:incoming>Flow_13e5yht</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_13e5yht" sourceRef="SendMessageNotifyUser" targetRef="end_event_draft_sending_failed" />
    <bpmn:endEvent id="end_event_draft_sent" name="sent without archiving">
      <bpmn:incoming>flow_archive_not_needed</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="flow_archive_not_needed" name="no" sourceRef="ArchiveMessageGateway" targetRef="end_event_draft_sent">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">#{archive == "no"}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:endEvent id="end_dvent_draft_sent_and_archived" name="sent and archived">
      <bpmn:incoming>Flow_sent_and_archived</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_sent_and_archived" sourceRef="ArchiveMessageActivity" targetRef="end_dvent_draft_sent_and_archived" />
    <bpmn:serviceTask id="SendMessageActivity" name="send" camunda:asyncBefore="true" camunda:delegateExpression="#{sendMessageDelegate}">
      <bpmn:extensionElements>
        <camunda:failedJobRetryTimeCycle>R3/PT1M</camunda:failedJobRetryTimeCycle>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_Message_moved_to_outbox</bpmn:incoming>
      <bpmn:outgoing>Flow_Message_sent</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="MoveToOutboxActivity" name="move to outbox" camunda:delegateExpression="#{moveMessageDelegate}">
      <bpmn:incoming>Flow_Message_Draft_Checked</bpmn:incoming>
      <bpmn:outgoing>Flow_Message_moved_to_outbox</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="MoveToSentActivity" name="move to sent" camunda:delegateExpression="#{moveMessageDelegate}">
      <bpmn:incoming>Flow_Message_sent</bpmn:incoming>
      <bpmn:outgoing>Flow_Message_Moved_to_sent</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="ArchiveMessageActivity" name="archive" camunda:delegateExpression="#{archiveMessageDelegate}">
      <bpmn:incoming>flow_archive_needed</bpmn:incoming>
      <bpmn:outgoing>Flow_sent_and_archived</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="ValidateDraftActivity" name="validate draft" camunda:delegateExpression="#{validateDraftDelegate}">
      <bpmn:incoming>Flow_0ee2l7i</bpmn:incoming>
      <bpmn:outgoing>Flow_Message_Draft_Checked</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="DraftValidationNotifyUser" name="notify user:&#10;check draft" camunda:delegateExpression="#{notifyUserDelegate}">
      <bpmn:incoming>Flow_0thveet</bpmn:incoming>
      <bpmn:outgoing>Flow_1wrsceu</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="SendMessageNotifyUser" name="notify user:&#10;send failed" camunda:delegateExpression="#{notifyUserDelegate}">
      <bpmn:incoming>Flow_1l7ej2t</bpmn:incoming>
      <bpmn:outgoing>Flow_13e5yht</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:boundaryEvent id="ValidateDraftError" attachedToRef="ValidateDraftActivity">
      <bpmn:outgoing>Flow_0thveet</bpmn:outgoing>
      <bpmn:errorEventDefinition id="ErrorEventDefinition_0s7r0xp" camunda:errorCodeVariable="errorCode" camunda:errorMessageVariable="errorMessage" />
    </bpmn:boundaryEvent>
    <bpmn:boundaryEvent id="SendDraftError" attachedToRef="SendMessageActivity">
      <bpmn:outgoing>Flow_1l7ej2t</bpmn:outgoing>
      <bpmn:errorEventDefinition id="ErrorEventDefinition_0xo9jmp" camunda:errorCodeVariable="errorCode" camunda:errorMessageVariable="errorMessage" />
    </bpmn:boundaryEvent>
    <bpmn:sequenceFlow id="Flow_1l7ej2t" name="sending failed" sourceRef="SendDraftError" targetRef="SendMessageNotifyUser" />
    <bpmn:textAnnotation id="TextAnnotation_079acrw">
      <bpmn:text>asyncBefore=false</bpmn:text>
    </bpmn:textAnnotation>
    <bpmn:association id="Association_0owf06d" sourceRef="ValidateDraftActivity" targetRef="TextAnnotation_079acrw" />
    <bpmn:textAnnotation id="TextAnnotation_1pl8yyo">
      <bpmn:text>asyncBefore=true</bpmn:text>
    </bpmn:textAnnotation>
    <bpmn:association id="Association_17wdc7t" sourceRef="SendMessageActivity" targetRef="TextAnnotation_1pl8yyo" />
    <bpmn:textAnnotation id="TextAnnotation_1bgjw2e">
      <bpmn:text>#{archive == "no"}</bpmn:text>
    </bpmn:textAnnotation>
    <bpmn:association id="Association_1a059o1" sourceRef="end_event_draft_sent" targetRef="TextAnnotation_1bgjw2e" />
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="SendDraftProcess">
      <bpmndi:BPMNShape id="TextAnnotation_1pl8yyo_di" bpmnElement="TextAnnotation_1pl8yyo">
        <dc:Bounds x="660" y="90" width="120" height="30" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="TextAnnotation_079acrw_di" bpmnElement="TextAnnotation_079acrw">
        <dc:Bounds x="350" y="90" width="120" height="30" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="TextAnnotation_1bgjw2e_di" bpmnElement="TextAnnotation_1bgjw2e">
        <dc:Bounds x="880" y="390" width="110" height="30" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1l7ej2t_di" bpmnElement="Flow_1l7ej2t">
        <di:waypoint x="611" y="258" />
        <di:waypoint x="611" y="330" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="592" y="291" width="68" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1019gz2_di" bpmnElement="Flow_sent_and_archived">
        <di:waypoint x="1000" y="240" />
        <di:waypoint x="1000" y="462" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_140hafi_di" bpmnElement="flow_archive_not_needed">
        <di:waypoint x="860" y="225" />
        <di:waypoint x="860" y="452" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="869" y="346" width="13" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_13e5yht_di" bpmnElement="Flow_13e5yht">
        <di:waypoint x="611" y="410" />
        <di:waypoint x="611" y="452" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1wrsceu_di" bpmnElement="Flow_1wrsceu">
        <di:waypoint x="310" y="420" />
        <di:waypoint x="310" y="462" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0thveet_di" bpmnElement="Flow_0thveet">
        <di:waypoint x="310" y="258" />
        <di:waypoint x="310" y="340" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="330" y="291" width="79" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_012mio8_di" bpmnElement="flow_archive_needed">
        <di:waypoint x="885" y="200" />
        <di:waypoint x="950" y="200" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="909" y="182" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_03rznf3_di" bpmnElement="Flow_Message_Moved_to_sent">
        <di:waypoint x="800" y="200" />
        <di:waypoint x="835" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1opc62t_di" bpmnElement="Flow_Message_sent">
        <di:waypoint x="660" y="200" />
        <di:waypoint x="700" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_017x4ks_di" bpmnElement="Flow_Message_moved_to_outbox">
        <di:waypoint x="500" y="200" />
        <di:waypoint x="560" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0n9zr3l_di" bpmnElement="Flow_Message_Draft_Checked">
        <di:waypoint x="350" y="200" />
        <di:waypoint x="400" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ee2l7i_di" bpmnElement="Flow_0ee2l7i">
        <di:waypoint x="198" y="200" />
        <di:waypoint x="250" y="200" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="start_event_dend_draft">
        <dc:Bounds x="162" y="182" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="156" y="225" width="49" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_192jwxl_di" bpmnElement="ArchiveMessageGateway" isMarkerVisible="true">
        <dc:Bounds x="835" y="175" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="815" y="143" width="90" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_06kt4ct_di" bpmnElement="end_event_draft_validation_failed">
        <dc:Bounds x="292" y="462" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="271" y="505" width="79" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0x887ce_di" bpmnElement="end_event_draft_sending_failed">
        <dc:Bounds x="593" y="452" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="577" y="495" width="68" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_088q0a6_di" bpmnElement="end_event_draft_sent">
        <dc:Bounds x="842" y="452" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="831" y="495" width="59" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0sfrh77_di" bpmnElement="end_dvent_draft_sent_and_archived">
        <dc:Bounds x="982" y="462" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="957" y="505" width="87" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_16s69l9_di" bpmnElement="SendMessageActivity">
        <dc:Bounds x="560" y="160" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0lnkt42_di" bpmnElement="MoveToOutboxActivity">
        <dc:Bounds x="400" y="160" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0tpnheq_di" bpmnElement="MoveToSentActivity">
        <dc:Bounds x="700" y="160" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1k156ce_di" bpmnElement="ArchiveMessageActivity">
        <dc:Bounds x="950" y="160" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_02tvhv8_di" bpmnElement="ValidateDraftActivity">
        <dc:Bounds x="250" y="160" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1gn376i_di" bpmnElement="DraftValidationNotifyUser">
        <dc:Bounds x="260" y="340" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_15d9uhl_di" bpmnElement="SendMessageNotifyUser">
        <dc:Bounds x="561" y="330" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Association_17wdc7t_di" bpmnElement="Association_17wdc7t">
        <di:waypoint x="648" y="160" />
        <di:waypoint x="686" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Association_0owf06d_di" bpmnElement="Association_0owf06d">
        <di:waypoint x="338" y="160" />
        <di:waypoint x="376" y="120" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Association_1a059o1_di" bpmnElement="Association_1a059o1">
        <di:waypoint x="873" y="458" />
        <di:waypoint x="914" y="420" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="Event_06jbfjl_di" bpmnElement="SendDraftError">
        <dc:Bounds x="593" y="222" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0hb5u7n_di" bpmnElement="ValidateDraftError">
        <dc:Bounds x="292" y="222" width="36" height="36" />
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
